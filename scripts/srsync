#!/bin/bash
source "$(which ember_bash_setup)" &> /dev/null

# Copy $1 into $2 and replace with pointers, skipping existing

[ "$(whoami)" != "root" ] && exec sudo -- "$0" "$@"
trap 'error-die "A fatal error was reported on ${BASH_SOURCE} line ${LINENO}."' ERR
#set -x

# FIXME: Add a --verify option to have it check that each item can be correctly recovered
if ! [ -d "$2" ]; then
    error-die "Destination is not a directory."
fi
#find "$1" -not -type f -exec rsync -lptgoDR --checksum "$1" "$2/" \;
find "$1" -type f -exec sregi_copy_write {} "$2" \;
rsync -a --ignore-existing --no-i-r "$1" "$2/"
find "$2/$(basename "$1")" -type d -empty -exec touch {}/.keep \;
find "$2/$(basename "$1")" -type f -exec sregi_replace_conditional {} \;
