#!/bin/bash
source "$(which ember_bash_setup)" &> /dev/null

# Copy $1 into $2 and replace with pointers

[ "$(whoami)" != "root" ] && exec sudo -- "$0" "$@"
trap 'error-die "A fatal error was reported on ${BASH_SOURCE} line ${LINENO}."' ERR

warn-timeout "Destination files and directories, if present, will be overwritten."
crystalWorkdir="$(crystallize-getconf 'WorkDirectory')"
streamId="scache-$(date +%Y-%m-%d-%H-%M-%S-%N)-$(xxd -pu <<< "$(date +%z)")"
crystalSubdir="$crystalWorkdir/$streamId"
mkdir -p "$crystalSubdir"
rsync -av --checksum --progress --no-i-r "$1" "$crystalSubdir/"
rsync -av --checksum --progress --no-i-r "$1" "$crystalSubdir/"
scache_store_files --replace "$crystalSubdir/$(basename "$1")"
rsync -av --checksum --progress --no-i-r "$crystalSubdir/$(basename "$1")" "$2/"
rsync -av --checksum --progress --no-i-r "$crystalSubdir/$(basename "$1")" "$2/"
rm -r "$crystalSubdir"
