#!/usr/bin/env bash
# shellcheck disable=SC1091
source ember_bash_setup &> /dev/null
#set -x

((EUID)) && exec sudo -- "$0" "$@"
trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO}."' ERR

sregDir=""
if [[ "$1" == "--sreg-dir" ]]; then
    shift
    sregDir="$1"
    shift
fi
sregDir="$(sregi_find_dir --sreg-dir "$sregDir" --full-check "${!#}")"

finish() {
    trap - ERR
    if [[ -e "$statusFile" ]]; then
        rm "$statusFile"
    fi
    if [[ -e "$crystalWorkdir/$instanceId" ]]; then
        rm -r "${crystalWorkdir:?}/${instanceId:?}"
    fi
    trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO} while finishing srsync."' ERR
}
trap 'error-notify "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO}."; finish; exit 1' ERR
trap finish EXIT

sregNoVerify="true"
if [[ "$1" == "--no-verify" ]]; then
    sregNoVerify="true"
    shift
fi
if [[ "$1" == "--verify" ]]; then
    sregNoVerify="false"
    shift
fi
if [[ "$sregNoVerify" == "true" ]]; then
    warn "(Not verifying pointers: use sreg_fsck to test the entire stream registry.)"
fi

if [[ "$#" == "1" ]]; then
    # There's only one path specified, so use the current directory as the destination
    destinationParameter="."
    pathsToCopy=("${@}") # all arguments
else
    # Multiple paths are specified, so use the last one as the destination
    destinationParameter="${!#}" # last argument
    pathsToCopy=("${@:1:$(($#-1))}") # all but last argument
fi

if ! [[ -d "$destinationParameter" ]]; then
    die "Destination is not a directory."
fi
echo "Counting items..."
crystalWorkdir="$(crystallize-getconf WorkDirectory)"
instanceId="srsync-$(date-uuid)"
mkdir -p "$crystalWorkdir/$instanceId"
statusFile="/tmp/$instanceId.srsync.status"
failCheckFile="/tmp/$instanceId.srsync.running"

find "${pathsToCopy[@]}" -type f -printf '.' | wc -c > "$statusFile"
destinationReplaced="${destinationParameter/%.git/.git.686fc528-0e8e-4724-91bb-c103cdcdd592}"
destinationReplaced="${destinationReplaced//\/.git\//\/.git.686fc528-0e8e-4724-91bb-c103cdcdd592\/}"
destinationSuffix=""

for path in "${pathsToCopy[@]}"; do
    sourceReplaced="${path/%.git/.git.686fc528-0e8e-4724-91bb-c103cdcdd592}"
    sourceReplaced="${path/%.git\//.git.686fc528-0e8e-4724-91bb-c103cdcdd592\/}"
    if [[ -d "$path" ]]; then
        destinationSuffix="/"
    fi
    if [[ "$path" =~ '/'$ ]]; then
        destinationRoot="$sourceReplaced"
        destinationFindTarget="$destinationReplaced$destinationSuffix"
    else
        destinationRoot="$(dirname "$sourceReplaced")"
        destinationFindTarget="$destinationReplaced/$(basename "$sourceReplaced")$destinationSuffix"
    fi
    if [[ "$destinationRoot" == "." ]]; then
        destinationRootLength="0"
    else
        destinationRootLength=${#destinationRoot}
    fi
    # Use $path in find commands rather than sourceReplaced because sourceReplaced is used for the target computation and post-processing (post-processing with find, that is).
    if [[ "$sregNoVerify" == "true" ]]; then
        find "$path" -type f -exec sregi_copy_write "$failCheckFile" --sreg-dir "$sregDir" --no-verify {} "$destinationReplaced" "$statusFile" "$destinationRootLength" \;
    else
        find "$path" -type f -exec sregi_copy_write "$failCheckFile" --sreg-dir "$sregDir" {} "$destinationReplaced" "$statusFile" "$destinationRootLength" \;
    fi
    # This NEEDS to skip regular files, because otherwise files that don't exist in the directory will be copied and take up space!
    # rsync -a --ignore-existing --no-i-r "${pathsToCopy[@]}" "$destinationParameter/"
    find "$destinationFindTarget" -type d -empty -exec touch {}/.keep \;
done

finish
