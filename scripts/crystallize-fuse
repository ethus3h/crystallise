#!/bin/bash
#It's Bouncy!
#syntax: crystallize-fuse [create|mount|unmount|reset] [name]
#crystallize-fuse attach [server username] [server] [name] [local mountpoint]
#crystallize-fuse status [name]
#crystallize-fuse stub
#Stub creates a fake EML instance for apps (e.g. Crystallise) that require it.

[ "$(whoami)" != "root" ] && exec sudo -- "$0" "$@"

action="$1"
name="$2"

case $action in
create)
    mkdir -p "/Wreathe/.Resources/RubberFS/$name/dev/"
    #4T doesn't work: "truncate: failed to truncate '/Wreathe/.Resources/RubberFS/library/dev/StorageBlockDevice1' at 4398046511104 bytes: File too large" â€” wtf?! I don't have 3tb available either.
    truncate -s 3T "/Wreathe/.Resources/RubberFS/$name/dev/StorageBlockDevice1"
    truncate -s 3T "/Wreathe/.Resources/RubberFS/$name/dev/StorageBlockDevice2"
    truncate -s 3T "/Wreathe/.Resources/RubberFS/$name/dev/StorageBlockDevice3"
    zpool create "$name" -o relatime raidz1 "/Wreathe/.Resources/RubberFS/$name/dev/StorageBlockDevice1"
    zfs set compression=gzip-9 "$name"
    zpool scrub "$name"
    zpool export "$name"
    echo "RubberFS named $name has been created. Run rubberfs mount $name to mount it."
    ;;
mount)
    zpool import "$name"
    zpool scrub "$name"
    ln -s "/$name" "/Wreathe/.Resources/RubberFS/$name/mount"
    echo "RubberFS named $name has been mounted."
    ;;
unmount)
    zpool export "$name"
    exit 1
attach)
    username="$1"
    server="$2"
    prefix="$3"
    mountpoint="$4"
    sshfs -o allow_other,defer_permissions "$username"@"$server":"/Wreathe/.Resources/RubberFS/$prefix/mount/" "$mountpoint"
    ;;
status)
    zpool list "$name"
    zpool status "$name"
    df -i /"$name"
    #zfs list -ro space -t snapshot
    zfs list -ro space "$name"
stub)
    mkdir -p /Ember\ Media\ Library/Futuramerlin\ Projects/Data/Crystal\ Index/
*)
    echo "Unknown action."
    exit 1
    ;;
esac
