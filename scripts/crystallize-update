#!/bin/bash
# Crystallize

#Script must be run as root.

#Usage: crystallize-update

[ "$(whoami)" != "root" ] && exec sudo -- "$0" "$@"

#Script should exit if any operation fails.
set -e

echo "Please wait until it says 'Done installing or updating crystallize'."

CrystalID=CrystallizeUpdate-$(date +%Y-%m-%d-%H-%M-%S-%N)-$(xxd -pu <<< "$(date +%z)")-$(python -c 'import uuid; print str(uuid.uuid4())')
export CrystalID

directoryToWorkIn="$(crystallize-getconf WorkDirectory)"

mkdir -v "$directoryToWorkIn"/"$CrystalID".git-tmp
cd "$directoryToWorkIn"/"$CrystalID".git-tmp
git clone https://github.com/ethus3h/crystallize
git clone https://github.com/ethus3h/wreathe
git clone https://github.com/jjjake/internetarchive
cd internetarchive
find ../wreathe/etc/portage/patches/dev-python/internetarchive -name "*.patch" -exec patch -p1 -i {} \;
pip install --upgrade .

cp -v /usr/local/bin/crystallize-update "/usr/local/bin/crystallize-update.old.$CrystalID"
crystallize /usr/local/bin/crystallize /usr/local/bin/decrystallize /usr/local/bin/decrystallize-logsession /usr/local/bin/crystallize-*
echo "Please wait; still updating..."

cd ../crystallize
make

set +e
mv /usr/local/etc/crystallize.conf /usr/local/etc/crystallize.conf.bak
set -e

exec /bin/bash -c 'sudo make install'

set +e
rm /usr/local/etc/crystallize.conf
mv /usr/local/etc/crystallize.conf.bak /usr/local/etc/crystallize.conf
