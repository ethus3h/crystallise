#!/bin/bash

# Do not run this script manually; use crystallize instead.

#Script should run as root.
[ "$(whoami)" != "root" ] && exec sudo -- "$0" "$@"

#Script should exit if any operation fails.
set -e
set -x

echo "The crystal will have the following address when it is ready: $CrystalID"

echo "Time (log stage 1) locally:"

date +%Y-%m-%d-%H-%M-%S-%N
xxd -pu <<< "$(date +%z)"

crystalWorkdir=$(crystallize-getconf 'WorkDirectory')
export crystalWorkdir

echo "Time (log stage 1) from http://timeapi.org/: "

set +e
wget --delete-after --warc-file="$crystalWorkdir/$CrystalID.time-start" -e robots=off "http://www.timeapi.org/utc/now?\Y-\m-\d-\H-\M-\S-\6N-\z";
set -e

echo "Time (log stage 1b) locally:"

date +%Y-%m-%d-%H-%M-%S-%N
xxd -pu <<< "$(date +%z)"

echo "Working in $crystalWorkdir".

echo "Arguments: " "$@"

echo "Configuration: "

cat /usr/local/etc/crystallize.conf

crystalTitle=$(crystallize-getconf 'InstallationIdentifier')
export crystalTitle
crystalCollection=$(crystallize-getconf 'Collection')
export crystalCollection
crystallizePassphrase=$(crystallize-getconf 'Passphrase')
export crystallizePassphrase

export CrystalID="$1"

echo "Environment: "

uname -ap

echo "Environment variables: "

printenv

echo "Network environment: "

echo "IP address from DNS: "

dig +short myip.opendns.com @resolver1.opendns.com

echo "IP address from http://icanhazip.com/: "

set +e
wget --delete-after --warc-file="$crystalWorkdir/$CrystalID.ip" -e robots=off http://icanhazip.com/;
set -e

echo "Time (log stage 2) locally:"

date +%Y-%m-%d-%H-%M-%S-%N
xxd -pu <<< "$(date +%z)"

echo "Time (log stage 2) from http://timeapi.org/: "

set +e
wget --delete-after --warc-file="$crystalWorkdir/$CrystalID.time-env" -e robots=off "http://www.timeapi.org/utc/now?\Y-\m-\d-\H-\M-\S-\6N-\z";
set -e

echo "Time (log stage 2b) locally:"

date +%Y-%m-%d-%H-%M-%S-%N
xxd -pu <<< "$(date +%z)"

echo "The crystal will have the following address when it is ready: $CrystalID"

printf "%s" "$crystallizePassphrase" > "$crystalWorkdir/$CrystalID".tmp

CrystallizeFirstArg="$1"
shift

#Needed because readlink isn't available in OS X. From http://stackoverflow.com/questions/17577093/how-do-i-get-the-absolute-directory-of-a-file-in-bash
function myreadlink() {
  (
  cd "$(dirname "$1")"         # or  cd ${1%/*}
  echo "$PWD"/"$(basename "$1")" # or  echo $PWD/${1##*/}
  )
}

export -f myreadlink

#Resolve relative paths in the arguments, since GNU tar's -P doesn't
CrystallizePaths=( "$@" )
# shellcheck disable=SC2128
echo "First entry in array: $CrystallizePaths"
for i in "${!CrystallizePaths[@]}"; do
    #resolve path
    echo "Trying to resolve ${CrystallizePaths[$i]}..."
    abspath="$(myreadlink "${CrystallizePaths[$i]}")"
    CrystallizePaths[$i]="$abspath"
done

echo "Building local index..."

hashdeep -c md5,sha1,sha256,tiger,whirlpool -e -o fbsd "$crystalWorkdir/""$CrystallizeFirstArg" "${CrystallizePaths[@]}" "$crystalWorkdir/$CrystalID" | tee "$crystalWorkdir/$CrystalID.local.idx"

echo "Building deep index..."
hashdeep -c md5,sha1,sha256,tiger,whirlpool -e -o fbsd -r "$crystalWorkdir/""$CrystallizeFirstArg" "${CrystallizePaths[@]}" "$crystalWorkdir/$CrystalID" | tee "$crystalWorkdir/$CrystalID.deep.idx"

echo "Counting size..."

crystalFilesSize="$(du -c "$crystalWorkdir/""$CrystallizeFirstArg" "${CrystallizePaths[@]}" "$crystalWorkdir/$CrystalID" | tail -1 | cut -f 1)"
crystalFilesSizeMult=$((crystalFilesSize * 1000))

#get available memory
memlimit=-1
if hash free 2>/dev/null; then
    if free | grep -q buff/cache; then
        #free has one column for buffers and cache
        memlimit="$(free | grep Mem: | awk 'FNR == 1 {print ($4+$6)}')"
    else
        #free has separate columns for buffers and cache
        memlimit="$(free | grep Mem: | awk 'FNR == 1 {print ($4+$6+$7)}')"
    fi
    #Output is in kilobytes
    memlimit="$((memlimit * 1000))"
elif hash vm_stat 2>/dev/null; then
    #The system doesn't have the free command; try vm_stat
    #use sum of free+inactive from vm_stat
    freel="$(vm_stat | grep "Pages free:" | awk 'FNR == 1 {print ($3)}')"
    free="${freel::${#freel}-1}"
    inactivel="$(vm_stat | grep "Pages inactive:" | awk 'FNR == 1 {print ($3)}')"
    inactive="${inactivel::${#inactivel}-1}"
    memlimit="$((free + inactive))"
    #Output is in 4096-byte pages
    memlimit="$((memlimit * 4096))"
else
    echo "Warning: Could not determine how much memory is available."
    sleep 3
fi

memlimit="$((memlimit - 1073741824))"

echo "cd \"$(pwd)\""
echo "CrystalID=\"$CrystalID\""
echo "crystalWorkdir=\"$crystalWorkdir\""
echo "crystalTitle=\"$crystalTitle\""
echo "crystallizeVersion=\"$crystallizeVersion\""
echo "crystalCollection=\"$crystalCollection\""

crystallizeAccessKey="$(grep access ~/.config/ia.ini | head -n 1 | awk '{ print $3 }')"
crystallizeSecretKey="$(grep secret ~/.config/ia.ini | head -n 1 | awk '{ print $3 }')"

CrystalFileName="$(basename "$crystalWorkdir/$CrystalID".coal5)"

echo "Filesize estimate: $crystalFilesSize"

echo "Sending..."
#FIXME: May continue even when hashdeep is missing
#pack files into stream | measure rate of stream's flow | compress the stream | encrypt the stream | send the input to a checksummer and to the output | send the stream to ia
sendRetries=0
until [ $sendRetries -ge 100 ]; do
    tar -cv -P -S --format pax "$crystalWorkdir/""$CrystallizeFirstArg" "${CrystallizePaths[@]}" "$crystalWorkdir/$CrystalID" "$crystalWorkdir/$CrystalID.local.idx" "$crystalWorkdir/$CrystalID.deep.idx" "$crystalWorkdir/$CrystalID.tmp" "$crystalWorkdir/$CrystalID.tmp" "$crystalWorkdir/$CrystalID.time-start.warc.gz" "$crystalWorkdir/$CrystalID.ip.warc.gz" "$crystalWorkdir/$CrystalID.time-env.warc.gz" | xz -k -C sha256 -T 0 --lzma2=preset=1 --memlimit-compress="$memlimit" --stdout - | gpg --yes -c -v --cipher-algo AES256 --batch --passphrase-file "$crystalWorkdir/$CrystalID".tmp - | tee >(hashdeep -c md5,sha1,sha256 -o fbcpsde > "$crystalWorkdir/$CrystalID.checksums") | pv -tparbIfei 0.1 -s "$crystalFilesSizeMult" | curl --location --data-binary "@-" --header "x-amz-auto-make-bucket:1" --header "x-archive-queue-derive:0" --header "Transfer-Encoding: chunked" --header "x-archive-size-hint:$crystalFilesSize" --header "authorization: LOW $crystallizeAccessKey:$crystallizeSecretKey" --header "x-archive-meta-collection:$crystalCollection" --header "x-archive-meta-title:$CrystalID" --header "x-archive-meta-description:do be do be do" --header "x-archive-meta-subject:Uploaded using Crystallize $crystallizeVersion; 1EA21BD8-DB7E-11E5-9733-728C37852114; $crystalTitle; $CrystalID" "http://s3.us.archive.org/$CrystalID/$CrystalFileName" && break
    sendRetries=$((sendRetries+1))
    sleep 30
done

getChecksumRetries=0
until [ $getChecksumRetries -ge 1000 ]; do
    wget -qO - https://archive.org/download/"$CrystalID/$CrystalID"_files.xml | grep "<file name=\"$CrystalFileName\" source=\"original\">" && break
    getChecksumRetries=$((getChecksumRetries+1))
    sleep 30
done

checksumLine="$(wget -qO - https://archive.org/download/"$CrystalID/$CrystalID"_files.xml | grep -A 3 "<file name=\"$CrystalFileName\" source=\"original\">" | tail -n 1)"
checksumLine="${checksumLine/    <md5>/}"
checksumLine="${checksumLine/<\/md5>/}"
knownChecksum="$(grep ",stdin" "$crystalWorkdir/$CrystalID.checksums" | awk -F',' '{print $2}')"
if [[ $checksumLine != $knownChecksum ]]; then
    echo "ERROR! Checksum known by Internet Archive does not match checksum known locally." >&2
    exit 1
fi

exitcode="${PIPESTATUS[0]}"

#Ignore exit code 1 from tar on Linux, which indicates files changed while reading; see http://stackoverflow.com/questions/20318852/tar-file-changed-as-we-read-it
if [ "$exitcode" != "0" ] && [[ $OSTYPE != *inux* ]]; then
    exit "$exitcode"
fi
if [ "$exitcode" != "1" ] && [ "$exitcode" != "0" ]; then
    exit "$exitcode"
fi

echo "Retrieving remote index..."

wget --delete-after --save-headers --output-document - "https://archive.org/metadata/$CrystalID/" | tee "$crystalWorkdir/$CrystalID.json"


unset opt
unset optb

set +e
#If GNU/Linux, set opt to 1 and unset optb; otherwise opposite
[[ $OSTYPE = *inux* ]] && (( opt++ ))
[[ $OSTYPE != *inux* ]] && (( optb++ ))
set -e

#If the opt(b) variable is unset, insert the text after "opt(b)+"
#opt is for GNU/Linux; optb is for others
script ${optb+/dev/null} ${opt+-e} ${opt+-c} crystallize-internal-xz-b ${opt+/dev/null}

echo "Copying indices..."

rsync -av --progress --checksum "$crystalWorkdir/$CrystalID.local.idx" "$crystalWorkdir/$CrystalID.deep.idx" "$crystalWorkdir/$CrystalID.checksums" "$crystalWorkdir/$CrystalID.json.xz" /Ember\ Library/Futuramerlin\ Projects/Data/Crystal\ Index/

echo "rsynced..."

#Clear the screen
printf "\033c"

#Delete everything except log
#echo "Cleaning up..."
#yes | rm -rv "${CrystallizePaths[@]}"
#echo "Done cleaning up..."

echo "Time (log stage 3) locally:"

date +%Y-%m-%d-%H-%M-%S-%N
xxd -pu <<< "$(date +%z)"

echo "Time (log stage 3) from http://timeapi.org/: "

set +e
wget --delete-after --warc-file="$crystalWorkdir/$CrystalID.time-done" -e robots=off "http://www.timeapi.org/utc/now?\Y-\m-\d-\H-\M-\S-\6N-\z";
set -e

echo "Time (log stage 3b) locally:"

date +%Y-%m-%d-%H-%M-%S-%N
xxd -pu <<< "$(date +%z)"

#Clear the screen
printf "\033c"

echo "Finishing $CrystalID..."

echo "Please wait..."
