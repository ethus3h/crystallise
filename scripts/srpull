#!/usr/bin/env bash
# shellcheck disable=SC1091
source ember_bash_setup &> /dev/null
#set -x

((EUID)) && exec sudo -- "$0" "$@"

sregDir=""
if [[ "$1" == "--sreg-dir" ]]; then
    shift
    sregDir="$1"
    shift
fi
sregDir="$(sregi_find_dir --sreg-dir "$sregDir" --full-check "$1")"

finish() {
    if [[ -e "${fsckId:?}" ]]; then
        rm -r "${fsckId:?}" "/tmp/${fsckId:?}.status"
    fi
}
trap 'error-notify "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO}."; finish; exit 1' ERR

srpullReplace="false"
if [[ "$1" == "--replace" ]]; then
    srpullReplace="true"
    shift
fi

pathsToCopy=("${@:1:$(($#-1))}") # all but last argument

if [[ "$srpullReplace" == "true" ]]; then
    rsync -av --checksum --progress --no-i-r "${pathsToCopy[@]}" "$2/"
    rsync -av --checksum --progress --no-i-r "${pathsToCopy[@]}" "$2/"
else
    rsync -av --checksum --progress --no-i-r --ignore-existing "${pathsToCopy[@]}" "$2/"
    rsync -av --checksum --progress --no-i-r --ignore-existing "${pathsToCopy[@]}" "$2/"
fi


destinationArgument="${!#}"
if [[ -z "$destinationArgument" ]]; then
    destinationArgument="."
fi

for path in "${pathsToCopy[@]}"; do
    if [[ -d "$1" ]]; then
        destinationFindTarget="$destinationArgument/$(basename "$1")/"
        if [[ "$1" =~ '/'$ ]]; then
            destinationFindTarget="$destinationArgument/"
        fi
    else
        destinationFindTarget="$destinationArgument/$(basename "$1")"
    fi

    fsckId="srpull-$(date +%Y-%m-%d-%H-%M-%S-%N)-$(xxd -pu <<< "$(date +%z)")"
    fsckStatusFile="/tmp/$fsckId.status"

    itemCount="$(find "$destinationFindTarget" -type f -printf '.' | wc -c)"
    if [[ -d "$1" ]]; then
        # Add 1 to the item count to account for the target folder itself
        echo "$((itemCount + 1))" > "$fsckStatusFile"
    else
        echo "$itemCount" > "$fsckStatusFile"
    fi

    sregi_expand_pointers --sreg-dir "$sregDir" "$fsckStatusFile" "$destinationFindTarget"

    find "$destinationFindTarget" -name ".git.686fc528-0e8e-4724-91bb-c103cdcdd592" -exec bash -c 'destName="$(basename "$1")"; mv "$1" "$(dirname "$1")/${destName%.686fc528-0e8e-4724-91bb-c103cdcdd592*}"' - {} \;
done

finish
