#!/usr/bin/env bash
# shellcheck disable=SC1091
source ember_bash_setup &> /dev/null
#set -x

((EUID)) && exec sudo -- "$0" "$@"
trap 'die "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO} in $(pwd) at $(emdate)."' ERR

cacheType="f"
cacheLimit="5000000000"
if [[ "$1" == "--localstore" ]]; then
    cacheType="localstore"
    cacheLimit="5000000000"
    shift
elif [[ "$1" == "--s" ]]; then
    cacheType="s"
    cacheLimit="5000000000"
    shift
elif [[ "$1" == "--f" ]]; then
    shift
fi

if [[ -e "$1"/."$cacheType"cache.limit ]]; then
    exit 0
elif [[ -d "$1" ]]; then
    if ! isSubdirOf "$(crystallize-getconf WorkDirectory)" "$1"; then
        error-notify "Directory already exists and is not a cache directory."
        exit 1
    fi
fi

cacheLimit=""
if [[ "$2" == +([0-9]) ]]; then
    # The 2nd argument is a positive integer
    cacheLimit="$2"
else
    die "If given, the 2nd argument to fcache_init must be a positive integer."
    ;;
fi

mkdir -p "$1/ByCount"

echo "$cacheLimit" > "$1"/."$cacheType"cache.limit
echo "Done creating cache directory."
