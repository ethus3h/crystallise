#!/usr/bin/env bash
# shellcheck disable=SC1091
source ember_bash_setup &> /dev/null
#set -x

((EUID)) && exec sudo -- "$0" "$@"

finish() {
    if [[ -e "${fsckId:?}" ]]; then
        rm -r "${fsckId:?}" "/tmp/${fsckId:?}.status"
    fi
}
trap 'error-notify "A fatal error was reported on ${BASH_SOURCE[0]} line ${LINENO}."; finish; exit 1' ERR

srpullReplace="false"
if [[ "$1" == "--replace" ]]; then
    srpullReplace="true"
    shift
fi

if [[ "$srpullReplace" == "true" ]]; then
    rsync -av --checksum --progress --no-i-r "$1" "$2/"
    rsync -av --checksum --progress --no-i-r "$1" "$2/"
else
    rsync -av --checksum --progress --no-i-r --ignore-existing "$1" "$2/"
    rsync -av --checksum --progress --no-i-r --ignore-existing "$1" "$2/"
fi

destinationArgument="$2"
if [[ -z "$2" ]]; then
    destinationArgument="."
fi

if [[ -d "$1" ]]; then
    destinationFindTarget="$destinationArgument/$(basename "$1")/"
    if [[ "$1" =~ '/'$ ]]; then
        destinationFindTarget="$destinationArgument/"
    fi
else
    destinationFindTarget="$destinationArgument/$(dirname "$1")"
fi

fsckId="srpull-$(date +%Y-%m-%d-%H-%M-%S-%N)-$(xxd -pu <<< "$(date +%z)")"
fsckStatusFile="/tmp/$fsckId.status"

itemCount="$(find "$destinationFindTarget" -type f -printf '.' | wc -c)"
# Add 1 to the item count to account for the target folder itself
echo "$((itemCount + 1))" > "$fsckStatusFile"

sregi_expand_pointers "$fsckStatusFile" "$destinationFindTarget"

find "$destinationFindTarget" -name ".git.686fc528-0e8e-4724-91bb-c103cdcdd592" -exec bash -c 'destName="$(basename "$1")"; mv "$1" "$(dirname "$1")/${destName%.686fc528-0e8e-4724-91bb-c103cdcdd592*}"' - {} \;

finish
