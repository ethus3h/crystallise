#!/bin/bash
source "$(which ember_bash_setup)" &> /dev/null

# Given a LocalStore pointer, replace it with a remote pointer
# First argument is the filename where the remote pointer data is stored; second is the pointer

trap 'error-die "A fatal error was reported on ${BASH_SOURCE} line ${LINENO}."' ERR

packPointerName="$1"
dbDir=/Ember\ Library/Futuramerlin\ Projects/Data/Stream\ Registry
hashFull="$(basename "$2")"
hashA="${hashFull:0:1}"
hashB="${hashFull:1:1}"
hashC="${hashFull:2:1}"
hashDir="$dbDir/$hashA/$hashB/$hashC"
dbFilePath="$hashDir/$hashFull"
if [ -f "$dbFilePath" ]; then
    if [[ "$(head -c 36 "$dbFilePath")" != "c39f8657-384b-438b-a5a2-eece17147589" ]]; then
        error-die "The item $dbFilePath does not appear to be a LocalStore pointer! This is most likely a bug in scache. Aborting to avoid messing things up."
    fi
fi
# 2fa... is the remote bundle pointer type signature
printf "2fae2004-94bb-4aa8-a01a-fc44298efc2c\n%s\n%s" "$hashFull" "$(basename "$packPointerName")" > "$dbFilePath"
